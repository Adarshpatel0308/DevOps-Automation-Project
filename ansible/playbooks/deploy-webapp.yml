
---
- name: Deploy web app via Kubernetes on all nodes
  hosts: k8s_nodes
  become: true
  tasks:
    - name: Create working dir
      file:
        path: /home/ubuntu/webapp
        state: directory
        owner: ubuntu
        group: ubuntu

    - name: Copy manifests
      synchronize:
        src: "{{ playbook_dir }}/../../k8s/"
        dest: "/home/ubuntu/webapp/"
        rsync_opts:
          - "--exclude=.git"
      delegate_to: localhost

    - name: Apply namespace
      shell: kubectl apply -f /home/ubuntu/webapp/namespace.yaml
      args: { executable: /bin/bash }

    - name: Apply configmap
      shell: kubectl apply -f /home/ubuntu/webapp/configmap.yaml
      args: { executable: /bin/bash }

    - name: Apply deployment
      shell: kubectl apply -f /home/ubuntu/webapp/deployment.yaml
      args: { executable: /bin/bash }

    - name: Apply service (NodePort 30080)
      shell: kubectl apply -f /home/ubuntu/webapp/service.yaml
      args: { executable: /bin/bash }

    - name: Wait for pods ready
      shell: kubectl rollout status deployment/webapp-deployment -n webapp --timeout=120s
      args: { executable: /bin/bash }

    - name: Print access URL
      debug:
        msg: "Access: http://{{ ansible_host }}:30080/"
